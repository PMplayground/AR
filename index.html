<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR PNG Sequence Animation</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      .loading { 
        position: absolute; 
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%); 
        color: white; 
        background: rgba(0,0,0,0.8);
        padding: 20px;
        border-radius: 10px;
        z-index: 1000; 
        font-family: Arial; 
      }
      .debug { 
        position: absolute; 
        top: 10px; 
        left: 10px; 
        color: white; 
        background: rgba(0,0,0,0.7);
        padding: 10px;
        z-index: 1000;
        font-family: Arial;
        font-size: 12px;
      }
    </style>
  </head>

  <body>
    <div id="loading" class="loading">Loading AR experience...</div>
    <div id="debug" class="debug"></div>
    
    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
    >
      <a-assets id="assets">
        <!-- Assets will be added here -->
      </a-assets>

      <a-marker preset="hiro">
        <a-plane
          id="animPlane"
          position="0 0 0"
          rotation="0 0 0"  <!-- CHANGED: No rotation for now -->
          width="3"
          height="5"
          material="src: #defaultFrame; transparent: true; alphaTest: 0.1;"
        ></a-plane>
      </a-marker>

      <!-- Add a default test frame -->
      <a-assets>
        <img id="defaultFrame" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==">
      </a-assets>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const loadingEl = document.getElementById('loading');
      const debugEl = document.getElementById('debug');
      const assetsEl = document.getElementById('assets');
      const plane = document.getElementById('animPlane');

      const TOTAL_FRAMES = 131; // CHANGE THIS to your actual frame count
      let framePaths = [];
      let currentFrame = 0;

      function updateDebug(info) {
        debugEl.innerHTML = info;
        console.log(info);
      }

      function initializeAnimation() {
        updateDebug('Initializing animation...');
        loadingEl.textContent = 'Setting up animation...';
        
        // Generate frame paths
        framePaths = [];
        for (let i = 1; i <= TOTAL_FRAMES; i++) {
          const frameNumber = String(i).padStart(4, "0");
          framePaths.push(`assets/frame_${frameNumber}.png`);
        }
        
        updateDebug(`Generated ${framePaths.length} frame paths`);
        preloadFrames();
      }

      function preloadFrames() {
        updateDebug('Starting frame preload...');
        loadingEl.textContent = `Preloading ${framePaths.length} frames...`;
        
        let loadedCount = 0;
        let errorCount = 0;

        framePaths.forEach((path, index) => {
          const img = new Image();
          img.onload = function() {
            loadedCount++;
            updateDebug(`Loaded: ${loadedCount}/${framePaths.length} frames`);
            loadingEl.textContent = `Loading frames... ${loadedCount}/${framePaths.length}`;
            
            // Add to A-Frame assets
            const imgEl = document.createElement('img');
            imgEl.setAttribute('id', `frame${index + 1}`);
            imgEl.setAttribute('src', path);
            assetsEl.appendChild(imgEl);

            if (loadedCount + errorCount === framePaths.length) {
              if (loadedCount > 0) {
                loadingEl.style.display = 'none';
                startAnimation();
              } else {
                loadingEl.textContent = 'âŒ No frames loaded! Check file paths.';
              }
            }
          };
          
          img.onerror = function() {
            errorCount++;
            console.error(`Failed to load: ${path}`);
            updateDebug(`Error loading: ${path}`);
            
            if (loadedCount + errorCount === framePaths.length) {
              if (loadedCount > 0) {
                loadingEl.style.display = 'none';
                startAnimation();
              } else {
                loadingEl.textContent = 'âŒ All frames failed to load!';
              }
            }
          };
          
          img.src = path;
        });
      }

      function startAnimation() {
        updateDebug('ðŸŽ¬ Starting animation!');
        
        const fps = 30;
        const frameDelay = 1000 / fps;
        let frameCounter = 0;

        const animationInterval = setInterval(() => {
          currentFrame = (currentFrame + 1) % framePaths.length;
          const srcId = `#frame${currentFrame + 1}`;
          frameCounter++;
          
          // Update the plane material
          plane.setAttribute('material', {
            src: srcId,
            transparent: true,
            alphaTest: 0.1
          });
          
          updateDebug(`Frame: ${currentFrame + 1}/${framePaths.length} | Total: ${frameCounter}`);
          
        }, frameDelay);

        plane.animationInterval = animationInterval;
      }

      // Add marker found/lost events to debug visibility
      const marker = document.querySelector('a-marker');
      marker.addEventListener('markerFound', () => {
        updateDebug('ðŸŽ¯ MARKER FOUND! Animation should be visible');
      });
      
      marker.addEventListener('markerLost', () => {
        updateDebug('âŒ MARKER LOST');
      });

      // Start when scene loads
      document.querySelector('a-scene').addEventListener('loaded', function() {
        updateDebug('Scene loaded');
        initializeAnimation();
      });

      // Test if plane is visible without marker
      setTimeout(() => {
        // Create a test plane that's always visible
        const testPlane = document.createElement('a-plane');
        testPlane.setAttribute('position', '0 0 -2');
        testPlane.setAttribute('width', '1');
        testPlane.setAttribute('height', '1');
        testPlane.setAttribute('color', 'red');
        testPlane.setAttribute('material', 'src', '#frame1');
        document.querySelector('a-scene').appendChild(testPlane);
        updateDebug('Added test plane (should see red square)');
      }, 2000);
    </script>
  </body>
</html>

