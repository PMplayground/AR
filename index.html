<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR PNG Sequence Animation</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      .loading { 
        position: absolute; 
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%); 
        color: white; 
        background: rgba(0,0,0,0.7);
        padding: 20px;
        border-radius: 10px;
        z-index: 1000; 
        font-family: Arial; 
      }
    </style>
  </head>

  <body>
    <div id="loading" class="loading">Loading AR experience...</div>
    
    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
    >
      <a-assets id="assets">
        <!-- Assets will be added here -->
      </a-assets>

      <a-marker preset="hiro">
        <a-plane
          id="animPlane"
          position="0 0.5 0"
          rotation="-90 0 0"
          width="1.5"
          height="1.5"
          material="transparent: true; opacity: 1;"
        ></a-plane>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const loadingEl = document.getElementById('loading');
      const assetsEl = document.getElementById('assets');
      const plane = document.getElementById('animPlane');

      // SIMPLE FRAME DETECTION - Change this number to match your actual frame count
      const TOTAL_FRAMES = 60; // Change this to your actual frame count
      
      // Or use auto-detection with a known range
      const KNOWN_FRAME_COUNT = 60; // Set this to your actual frame count

      let framePaths = [];

// REPLACE the initializeAnimation function with this:
function initializeAnimation() {
    const TOTAL_FRAMES = 131; // CHANGE THIS to your actual frame count
    
    loadingEl.textContent = `Setting up ${TOTAL_FRAMES} frames...`;
    
    framePaths = [];
    for (let i = 1; i <= TOTAL_FRAMES; i++) {
        const frameNumber = String(i).padStart(4, "0");
        framePaths.push(`assets/frame_${frameNumber}.png`);
    }
    
    preloadFrames();
}

      function preloadFrames() {
        loadingEl.textContent = `Preloading ${framePaths.length} frames...`;
        console.log('Frame paths:', framePaths);
        
        let loadedCount = 0;
        const totalFrames = framePaths.length;

        framePaths.forEach((path, index) => {
          const img = new Image();
          img.onload = function() {
            loadedCount++;
            loadingEl.textContent = `Loading frames... ${loadedCount}/${totalFrames}`;
            
            // Add to A-Frame assets
            const imgEl = document.createElement('img');
            imgEl.setAttribute('id', `frame${index + 1}`);
            imgEl.setAttribute('src', path);
            assetsEl.appendChild(imgEl);

            // Start animation when all frames are loaded
            if (loadedCount === totalFrames) {
              loadingEl.style.display = 'none';
              startAnimation();
            }
          };
          
          img.onerror = function() {
            console.error(`Failed to load: ${path}`);
            loadedCount++;
            // Continue even if some frames fail
            if (loadedCount === totalFrames) {
              loadingEl.style.display = 'none';
              startAnimation();
            }
          };
          
          img.src = path;
        });
      }

      function startAnimation() {
        console.log(`Starting animation with ${framePaths.length} frames`);
        
        let currentFrame = 0;
        const fps = 24; // Adjust frame rate as needed
        const frameDelay = 1000 / fps;

        const animationInterval = setInterval(() => {
          currentFrame = (currentFrame + 1) % framePaths.length;
          const srcId = `#frame${currentFrame + 1}`;
          
          plane.setAttribute('material', 'src', srcId);
        }, frameDelay);

        // Store interval reference in case we need to stop it later
        plane.animationInterval = animationInterval;
      }

      // Start everything when the scene loads
      document.querySelector('a-scene').addEventListener('loaded', function() {
        console.log('Scene loaded, initializing animation...');
        initializeAnimation();
      });

      // Fallback timeout
      setTimeout(() => {
        if (loadingEl.style.display !== 'none') {
          loadingEl.innerHTML = `
            Still loading...<br>
            Check:<br>
            1. Files are in /assets/ folder<br>
            2. Named: frame_0001.png, frame_0002.png, etc.<br>
            3. Browser console for errors
          `;
        }
      }, 3000);
    </script>
  </body>
</html>
